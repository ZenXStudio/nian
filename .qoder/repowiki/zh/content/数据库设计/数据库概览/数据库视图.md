# 数据库视图

<cite>
**本文档引用的文件**
- [init.sql](file://database/init.sql#L316-L345)
- [admin.controller.ts](file://backend/src/controllers/admin.controller.ts#L389-L435)
- [admin.controller.ts](file://backend/src/controllers/admin.controller.ts#L437-L467)
- [admin.controller.ts](file://backend/src/controllers/admin.controller.ts#L608-L655)
- [admin.controller.ts](file://backend/src/controllers/admin.controller.ts#L657-L698)
- [admin.controller.ts](file://backend/src/controllers/admin.controller.ts#L700-L747)
- [admin.controller.ts](file://backend/src/controllers/admin.controller.ts#L818-L844)
- [admin.controller.ts](file://backend/src/controllers/admin.controller.ts#L888-L947)
</cite>

## 目录
1. [用户练习统计视图](#用户练习统计视图)
2. [方法热度统计视图](#方法热度统计视图)
3. [视图在后端API中的应用](#视图在后端api中的应用)
4. [数据导出功能中的视图应用](#数据导出功能中的视图应用)
5. [视图设计优势分析](#视图设计优势分析)

## 用户练习统计视图

`user_practice_stats` 视图通过聚合 `users` 和 `practice_records` 表的数据，为系统提供了关键的用户练习统计指标。该视图使用 LEFT JOIN 连接用户表和练习记录表，确保即使没有练习记录的用户也能被包含在统计结果中。视图计算了四个核心指标：总练习次数（`total_practices`）通过计算练习记录ID的去重计数获得；总练习时长（`total_duration`）通过汇总练习时长分钟数得到，使用 COALESCE 函数处理空值情况；练习天数（`practice_days`）通过计算练习日期的去重计数来衡量用户的练习频率；平均情绪改善值（`avg_mood_improvement`）通过计算练习后心情与练习前心情差值的平均值得出，同样使用 COALESCE 函数将空值处理为0。

**本节来源**
- [init.sql](file://database/init.sql#L316-L327)

## 方法热度统计视图

`method_popularity` 视图通过整合 `methods`、`user_methods` 和 `practice_records` 三个表的数据，为方法推荐算法提供了全面的数据支持。该视图首先从 `methods` 表中获取方法的基本信息，并通过 LEFT JOIN 连接 `user_methods` 表来统计选择该方法的独立用户数（`unique_users`），这反映了方法的受欢迎程度。同时，视图通过连接 `practice_records` 表计算了方法的总练习次数（`total_practices`）。视图还计算了平均有效性（`avg_effectiveness`），即用户练习该方法后情绪改善的平均值，这一指标对于评估方法的实际效果至关重要。视图通过 WHERE 子句筛选状态为 "published" 的方法，确保统计数据的准确性，并按选择次数降序排列，便于识别最受欢迎的方法。

**本节来源**
- [init.sql](file://database/init.sql#L329-L345)

## 视图在后端API中的应用

数据库视图极大地简化了后端统计API的查询逻辑。在 `admin.controller.ts` 中，`getUserStatistics` 函数通过直接查询基础表来获取用户统计信息，而 `getMethodStatistics` 函数则可以利用 `method_popularity` 视图来获取方法的热度数据。视图的使用使得API控制器代码更加简洁，将复杂的聚合逻辑封装在数据库层，提高了查询效率。例如，获取方法统计信息时，可以直接从视图中选择数据，而无需在应用代码中编写复杂的JOIN和GROUP BY语句。这种设计模式不仅减少了代码重复，还提高了数据查询的一致性和可维护性。

**本节来源**
- [admin.controller.ts](file://backend/src/controllers/admin.controller.ts#L389-L435)
- [admin.controller.ts](file://backend/src/controllers/admin.controller.ts#L437-L467)

## 数据导出功能中的视图应用

视图为管理后台的数据导出和报表功能提供了标准化的数据接口。在 `admin.controller.ts` 中，`exportUsers`、`exportMethods` 和 `exportPractices` 等导出函数虽然直接查询基础表，但视图的设计理念为这些功能提供了参考。例如，`getUserDetail` 函数查询用户详情时，其SQL逻辑与 `user_practice_stats` 视图类似，计算了用户的总练习时长和平均情绪改善值。这种设计确保了不同功能模块间统计数据的一致性。视图作为标准化的数据接口，可以在未来被直接用于数据导出，避免在多个导出函数中重复编写相同的聚合逻辑，同时通过视图的权限控制，可以更好地保护底层数据的安全性。

**本节来源**
- [admin.controller.ts](file://backend/src/controllers/admin.controller.ts#L608-L655)
- [admin.controller.ts](file://backend/src/controllers/admin.controller.ts#L657-L698)
- [admin.controller.ts](file://backend/src/controllers/admin.controller.ts#L700-L747)
- [admin.controller.ts](file://backend/src/controllers/admin.controller.ts#L818-L844)
- [admin.controller.ts](file://backend/src/controllers/admin.controller.ts#L888-L947)

## 视图设计优势分析

数据库视图在本系统中展现了多重设计优势。首先，视图简化了复杂查询，将多表连接和聚合操作封装在数据库层，使应用代码更加简洁和易于维护。其次，视图提高了数据安全性，通过为不同用户角色提供不同的视图，可以限制对敏感数据的访问，例如管理后台可以通过视图获取统计信息，而无需直接访问原始数据表。再者，视图提供了标准化的数据接口，确保了不同功能模块间统计数据的一致性，避免了因查询逻辑不一致导致的数据差异。最后，视图提升了查询性能，数据库可以对视图进行优化和索引，对于频繁使用的统计查询，视图可以显著提高响应速度。这些优势共同使得视图成为构建高效、安全和可维护的后端系统的重要工具。