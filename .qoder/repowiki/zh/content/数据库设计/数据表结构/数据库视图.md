# 数据库视图

<cite>
**本文档引用的文件**   
- [init.sql](file://database/init.sql#L317-L345)
- [practice.controller.ts](file://backend/src/controllers/practice.controller.ts#L174-L260)
- [admin.controller.ts](file://backend/src/controllers/admin.controller.ts#L389-L467)
- [practice_stats_bloc.dart](file://flutter_app/lib/presentation/practice/bloc/practice_stats_bloc.dart)
- [practice_stats.dart](file://flutter_app/lib/domain/entities/practice_stats.dart)
- [Dashboard.tsx](file://home/user/nian/admin-web/src/pages/Dashboard.tsx)
- [api.ts](file://home/user/nian/admin-web/src/services/api.ts)
</cite>

## 目录
1. [用户练习统计视图](#用户练习统计视图)
2. [方法热度统计视图](#方法热度统计视图)
3. [视图在数据分析中的应用](#视图在数据分析中的应用)
4. [视图在管理后台中的应用](#视图在管理后台中的应用)
5. [性能优化与查询简化](#性能优化与查询简化)

## 用户练习统计视图

`user_practice_stats`视图通过LEFT JOIN聚合用户的总练习次数、总时长、练习天数和平均情绪改善值，为个人统计功能提供数据支持。该视图从users表开始，左连接practice_records表，通过GROUP BY对每个用户进行分组聚合。

视图计算了四个关键指标：`total_practices`（总练习次数）使用COUNT(DISTINCT pr.id)计算；`total_duration`（总时长）使用COALESCE(SUM(pr.duration_minutes), 0)计算，确保空值返回0；`practice_days`（练习天数）使用COUNT(DISTINCT pr.practice_date)计算，统计不同日期的练习天数；`avg_mood_improvement`（平均情绪改善值）使用COALESCE(AVG(pr.mood_after - pr.mood_before), 0)计算，通过练习前后情绪评分的差值来衡量心理状态改善效果。

在后端代码中，`getPracticeStatistics`控制器方法实现了类似但更灵活的统计功能，支持按周、月、年等不同时间段进行统计，并提供了心理状态趋势和方法练习分布等额外信息。前端Flutter应用通过`PracticeStats`实体类定义了统计数据结构，包括总练习次数、总时长、平均情绪改善等属性。

**Section sources**
- [init.sql](file://database/init.sql#L317-L327)
- [practice.controller.ts](file://backend/src/controllers/practice.controller.ts#L174-L260)
- [practice_stats.dart](file://flutter_app/lib/domain/entities/practice_stats.dart)

## 方法热度统计视图

`method_popularity`视图计算方法的唯一用户数、总练习次数和平均有效性，支撑热门方法推荐算法。该视图从methods表开始，左连接user_methods和practice_records表，通过GROUP BY对每个方法进行分组聚合。

视图计算了三个核心指标：`unique_users`（唯一用户数）使用COUNT(DISTINCT um.user_id)计算，反映方法的用户覆盖广度；`total_practices`（总练习次数）使用COUNT(DISTINCT pr.id)计算，衡量方法的使用频率；`avg_effectiveness`（平均有效性）使用COALESCE(AVG(pr.mood_after - pr.mood_before), 0)计算，评估方法的实际效果。

视图还包含了methods表的view_count（浏览次数）和select_count（选择次数）字段，这些指标共同构成了方法热度的综合评价体系。WHERE子句过滤出status为'published'的方法，确保只统计已发布的内容。ORDER BY子句按select_count降序排列，便于快速获取最受欢迎的方法。

**Section sources**
- [init.sql](file://database/init.sql#L330-L345)
- [method.controller.ts](file://backend/src/controllers/method.controller.ts#L100-L136)

## 视图在数据分析中的应用

`user_practice_stats`和`method_popularity`视图在数据分析中发挥着重要作用。在用户个人统计功能中，`user_practice_stats`视图为用户提供全面的练习概览，帮助用户了解自己的练习习惯和心理状态改善情况。通过长期跟踪这些指标，用户可以评估不同心理自助方法的效果，调整练习策略。

`method_popularity`视图为推荐系统提供了数据基础。系统可以根据方法的唯一用户数、总练习次数和平均有效性等指标，构建推荐算法。例如，可以优先推荐高有效性且被广泛使用的热门方法，或者为特定用户群体推荐他们同类用户常练习的方法。这种基于数据的推荐比简单的热门排序更具个性化和科学性。

在用户行为分析中，这两个视图可以帮助识别用户参与度模式。例如，通过分析`user_practice_stats`中的练习天数和连续练习天数，可以识别出高参与度用户和可能流失的用户。通过分析`method_popularity`中的选择次数和有效性，可以评估新发布方法的接受度和实际效果。

**Section sources**
- [practice.controller.ts](file://backend/src/controllers/practice.controller.ts#L174-L260)
- [method.controller.ts](file://backend/src/controllers/method.controller.ts#L100-L136)

## 视图在管理后台中的应用

在管理后台中，`user_practice_stats`和`method_popularity`视图为管理员提供了关键的运营数据洞察。管理后台的仪表板（Dashboard.tsx）显示了总用户数、总方法数、待审核方法和总练习记录等核心指标，这些数据的获取可以借鉴视图的设计思路。

`method_popularity`视图直接支持管理后台的热门方法分析功能。管理员可以通过这些数据了解哪些方法最受欢迎，哪些方法效果最好，从而指导内容运营策略。例如，可以重点推广高有效性但用户数较少的优质方法，或者对低有效性但高使用量的方法进行优化。

在用户管理功能中，`user_practice_stats`视图的指标可以帮助管理员识别活跃用户和潜在问题用户。通过分析用户的练习频率和情绪改善情况，管理员可以设计针对性的用户激励计划或提供额外支持。这些视图还为数据导出功能提供了基础，管理员可以导出详细的用户和方法统计报表用于进一步分析。

**Section sources**
- [admin.controller.ts](file://backend/src/controllers/admin.controller.ts#L389-L467)
- [Dashboard.tsx](file://home/user/nian/admin-web/src/pages/Dashboard.tsx)
- [api.ts](file://home/user/nian/admin-web/src/services/api.ts)

## 性能优化与查询简化

`user_practice_stats`和`method_popularity`视图通过预计算和聚合显著提升了查询性能。在没有视图的情况下，每次获取用户或方法统计信息都需要执行复杂的JOIN和GROUP BY操作，这在数据量大时会导致性能问题。视图将这些计算预先完成，使得查询操作变得简单高效。

视图简化了应用程序代码，避免了在多个地方重复编写复杂的SQL聚合查询。前端应用和后端服务可以直接查询视图获取所需数据，而不需要了解底层表结构的复杂性。这种抽象层提高了代码的可维护性，当需要修改统计逻辑时，只需更新视图定义，而不需要修改所有使用这些数据的应用代码。

此外，视图提供了数据一致性保证。由于统计逻辑集中在视图定义中，所有使用视图的应用都基于相同的计算规则，避免了因不同实现方式导致的数据不一致问题。这种集中管理的方式也便于性能优化，数据库可以对视图进行专门的优化，如创建适当的索引。

**Section sources**
- [init.sql](file://database/init.sql#L317-L345)
- [practice.controller.ts](file://backend/src/controllers/practice.controller.ts#L174-L260)