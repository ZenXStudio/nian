# 用户统计

<cite>
**本文档引用的文件**  
- [admin.controller.ts](file://backend/src/controllers/admin.controller.ts)
- [admin.routes.ts](file://backend/src/routes/admin.routes.ts)
- [database.ts](file://backend/src/config/database.ts)
- [init.sql](file://database/init.sql)
- [Dashboard.tsx](file://home/user/nian/admin-web/src/pages/Dashboard.tsx)
- [api.ts](file://home/user/nian/admin-web/src/services/api.ts)
</cite>

## 目录
1. [接口实现逻辑](#接口实现逻辑)
2. [用户趋势图数据生成](#用户趋势图数据生成)
3. [查询性能优化措施](#查询性能优化措施)
4. [管理后台可视化应用](#管理后台可视化应用)
5. [缓存机制提升响应速度](#缓存机制提升响应速度)

## 接口实现逻辑

`getUserStatistics` 接口的实现逻辑主要在后端的 `admin.controller.ts` 文件中定义。该接口通过多个独立的数据库查询来计算总用户数、活跃用户数和新增用户数。

- **总用户数**：通过 `COUNT(*)` 聚合函数查询 `users` 表中的所有记录数量。查询支持可选的日期范围过滤，允许管理员查看特定时间段内的用户总数。
- **活跃用户数（近7天有练习记录）**：通过查询 `practice_records` 表中 `practice_date` 大于等于当前日期减去7天的记录，并使用 `COUNT(DISTINCT user_id)` 统计唯一用户ID的数量，从而得出近7天内有练习记录的活跃用户数。
- **新增用户数（近7天注册）**：通过查询 `users` 表中 `created_at` 大于等于当前日期减去7天的记录，并使用 `COUNT(*)` 计算这些新注册用户的总数。

这些查询被设计为独立执行，以确保每个统计指标的计算逻辑清晰且互不影响。

**Section sources**
- [admin.controller.ts](file://backend/src/controllers/admin.controller.ts#L390-L435)

## 用户趋势图数据生成

用户趋势图的数据生成通过一个聚合查询实现，该查询从 `users` 表中提取近30天内每日的注册量，并按日期进行分组和排序。

- **聚合查询**：使用 `GROUP BY DATE(created_at)` 将 `created_at` 时间戳按日期进行分组，从而将同一日期的所有注册记录归为一组。
- **时间序列排序**：使用 `ORDER BY date` 确保结果按日期升序排列，形成一个连续的时间序列，便于前端绘制趋势图。
- **数据格式**：查询返回一个包含 `date` 和 `count` 两个字段的结果集，其中 `date` 表示注册日期，`count` 表示该日期的注册用户数量。

此查询的结果直接用于前端图表的渲染，提供了一个直观的用户增长趋势视图。

**Section sources**
- [admin.controller.ts](file://backend/src/controllers/admin.controller.ts#L418-L424)

## 查询性能优化措施

为了确保 `getUserStatistics` 接口的高效执行，采取了多项查询性能优化措施。

- **避免全表扫描**：通过在查询条件中使用索引字段（如 `created_at` 和 `practice_date`），数据库可以快速定位到相关记录，而无需扫描整个表。
- **合理使用索引**：在 `users` 表的 `created_at` 字段和 `practice_records` 表的 `practice_date` 字段上创建了索引，显著加快了基于时间范围的查询速度。
- **减少数据库往返次数**：虽然当前实现中使用了多个独立查询，但每个查询都经过优化，确保单次查询的执行效率。此外，通过使用参数化查询，减少了SQL注入的风险，并提高了查询的可缓存性。

这些优化措施共同作用，确保了即使在用户数据量较大的情况下，接口也能保持较低的响应时间。

**Section sources**
- [init.sql](file://database/init.sql#L17)
- [init.sql](file://database/init.sql#L76)

## 管理后台可视化应用

`getUserStatistics` 接口的统计结果在管理后台的 `Dashboard` 页面中得到了可视化应用。`Dashboard.tsx` 文件中的组件通过调用 `getAdminStats` API 获取统计数据，并将其展示为直观的卡片和图表。

- **数据概览卡片**：页面顶部展示了总用户数、总方法数、待审核方法数和总练习记录数等关键指标，每个指标都配有相应的图标和颜色编码，便于快速识别。
- **分类统计图表**：页面下方展示了方法的分类统计和难度统计，通过简单的文本列表形式呈现，清晰地反映了各类方法的分布情况。

这种可视化设计使得管理员能够一目了然地掌握平台的整体运营状况。

**Section sources**
- [Dashboard.tsx](file://home/user/nian/admin-web/src/pages/Dashboard.tsx#L1-L107)
- [api.ts](file://home/user/nian/admin-web/src/services/api.ts#L23-L26)

## 缓存机制提升响应速度

尽管当前代码中未直接实现缓存逻辑，但项目架构中已集成 Redis 作为缓存解决方案，为提升接口响应速度提供了基础。

- **Redis 集成**：在 `database.ts` 配置文件中，定义了 Redis 客户端的连接参数，表明系统具备使用 Redis 进行缓存的能力。
- **缓存策略建议**：可以将 `getUserStatistics` 接口的响应结果缓存一段时间（如5分钟），在此期间内，后续请求可以直接从缓存中获取数据，而无需再次查询数据库，从而显著降低数据库负载并提高响应速度。
- **性能优化建议**：根据 `QUALITY_REPORT.md` 中的性能优化建议，实施 Redis 缓存策略是提升 API 响应性能的关键步骤之一。

通过合理利用 Redis 缓存，可以有效应对高并发场景下的性能挑战，确保管理后台的流畅体验。

**Section sources**
- [database.ts](file://backend/src/config/database.ts#L16-L22)
- [QUALITY_REPORT.md](file://docs/QUALITY_REPORT.md#L217-L221)